<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firm Profiles - LSCA</title>
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --lsca-green: #4CAF50;
            --lsca-green-dark: #2D3E2F;
            --lsca-green-light: #E8F5E9;
            --grade-a: #22c55e;
            --grade-b: #84cc16;
            --grade-c: #eab308;
            --grade-d: #f97316;
            --grade-f: #ef4444;
            --text-dark: #1f2937;
            --text-muted: #6b7280;
            --border: #e5e7eb;
            --bg-light: #f9fafb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-dark);
            background: #fff;
            line-height: 1.6;
        }

        /* Header */
        .site-header {
            background: #fff;
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            height: 50px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--lsca-green-dark);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-links a:hover {
            color: var(--lsca-green);
        }

        .nav-links a.active {
            color: var(--lsca-green);
            border-bottom: 2px solid var(--lsca-green);
            padding-bottom: 2px;
        }

        /* Page Title */
        .page-title {
            background: var(--lsca-green-light);
            padding: 3rem 2rem;
            text-align: center;
        }

        .page-title h1 {
            font-size: 2.5rem;
            color: var(--lsca-green-dark);
            margin-bottom: 0.5rem;
        }

        .page-title h1 em {
            font-style: italic;
            font-weight: 400;
        }

        .page-title p {
            color: var(--text-muted);
            max-width: 700px;
            margin: 0 auto;
        }

        /* Search Section */
        .search-section {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .search-bar {
            display: flex;
            gap: 1rem;
            max-width: 600px;
        }

        .search-input {
            flex: 1;
            padding: 0.875rem 1.25rem;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--lsca-green);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* Main Layout */
        .main-layout {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem 4rem;
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 2rem;
        }

        /* Filter Sidebar */
        .filter-sidebar {
            background: var(--bg-light);
            border-radius: 12px;
            padding: 1.5rem;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .filter-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border);
        }

        .filter-group {
            margin-bottom: 1.5rem;
        }

        .filter-group-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            color: var(--lsca-green-dark);
        }

        .filter-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .filter-option input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--lsca-green);
        }

        .filter-option .grade-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.75rem;
            color: #fff;
        }

        .filter-placeholder {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-style: italic;
            padding: 0.5rem;
            background: #fff;
            border-radius: 6px;
            border: 1px dashed var(--border);
        }

        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--lsca-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Grade Buckets */
        .grade-bucket {
            margin-bottom: 3rem;
        }

        .grade-bucket.hidden {
            display: none;
        }

        .bucket-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 3px solid var(--border);
        }

        .bucket-grade {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 2rem;
            color: #fff;
        }

        .bucket-info h2 {
            font-size: 1.25rem;
            color: var(--lsca-green-dark);
            margin-bottom: 0.125rem;
        }

        .bucket-info p {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .bucket-count {
            margin-left: auto;
            background: var(--bg-light);
            padding: 0.5rem 1rem;
            border-radius: 100px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Grade-specific bucket styling */
        .grade-bucket[data-grade="A"] .bucket-header { border-bottom-color: var(--grade-a); }
        .grade-bucket[data-grade="B"] .bucket-header { border-bottom-color: var(--grade-b); }
        .grade-bucket[data-grade="C"] .bucket-header { border-bottom-color: var(--grade-c); }
        .grade-bucket[data-grade="D"] .bucket-header { border-bottom-color: var(--grade-d); }
        .grade-bucket[data-grade="F"] .bucket-header { border-bottom-color: var(--grade-f); }

        /* Firm Cards Grid */
        .firms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
        }

        .firm-card {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.25rem;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }

        .firm-card:hover {
            border-color: var(--lsca-green);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }

        .firm-card.hidden {
            display: none;
        }

        .card-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .vault-rank {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-light);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        .compare-checkbox {
            opacity: 0.4;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .firm-card:hover .compare-checkbox {
            opacity: 1;
        }

        .compare-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--lsca-green);
        }

        .logo-placeholder {
            width: 100%;
            height: 80px;
            background: var(--bg-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            border: 1px dashed var(--border);
        }

        .logo-placeholder span {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .firm-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--lsca-green-dark);
            text-align: center;
            margin-bottom: 1rem;
            min-height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1.3;
        }

        .card-grades {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .overall-grade {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.5rem;
            color: #fff;
        }

        .sub-grades {
            display: flex;
            gap: 0.375rem;
        }

        .sub-grade {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.125rem;
        }

        .sub-grade-icon {
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .sub-grade-value {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            font-weight: 700;
            font-size: 0.7rem;
            color: #fff;
        }

        /* No Results */
        .no-results {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .no-results h3 {
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        /* Footer */
        .site-footer {
            background: var(--lsca-green-dark);
            color: #fff;
            padding: 3rem 2rem;
            text-align: center;
        }

        .footer-logo {
            height: 40px;
            filter: brightness(0) invert(1);
            margin-bottom: 1rem;
        }

        .footer-text {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .filter-sidebar {
                position: static;
            }
        }

        @media (max-width: 600px) {
            .page-title h1 {
                font-size: 1.75rem;
            }

            .firms-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Firm Logo */
        .firm-logo {
            max-width: 100%;
            max-height: 70px;
            object-fit: contain;
        }

        .logo-placeholder.has-logo {
            border: none;
            background: #fff;
        }

        /* Compare Bar */
        .compare-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--lsca-green-dark);
            color: #fff;
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 200;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.15);
        }

        .compare-bar.visible {
            transform: translateY(0);
        }

        .compare-bar-content {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .compare-count {
            font-weight: 600;
        }

        .selected-firms {
            display: flex;
            gap: 0.5rem;
        }

        .selected-firm-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .selected-firm-tag .remove {
            cursor: pointer;
            opacity: 0.7;
            font-size: 1rem;
            line-height: 1;
        }

        .selected-firm-tag .remove:hover {
            opacity: 1;
        }

        .compare-bar-actions {
            display: flex;
            gap: 1rem;
        }

        .compare-btn {
            background: var(--lsca-green);
            color: #fff;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .compare-btn:hover {
            background: #3d9140;
        }

        .clear-btn {
            background: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .clear-btn:hover {
            border-color: #fff;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 300;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 2rem;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: #fff;
            border-radius: 16px;
            max-width: 1000px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h2 {
            font-size: 1.5rem;
            color: var(--lsca-green-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            padding: 0.5rem;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--text-dark);
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
        }

        /* Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .comparison-table th {
            background: var(--bg-light);
            font-weight: 600;
            color: var(--lsca-green-dark);
        }

        .comparison-table th:first-child,
        .comparison-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-light);
            position: sticky;
            left: 0;
        }

        .comparison-table .firm-header {
            vertical-align: bottom;
        }

        .comparison-table .firm-header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .comparison-table .firm-header-logo {
            height: 40px;
            width: auto;
            max-width: 120px;
            object-fit: contain;
        }

        .comparison-table .firm-header-name {
            font-size: 0.9rem;
            line-height: 1.3;
        }

        .comparison-table .firm-header-rank {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .comparison-table .grade-cell {
            font-weight: 700;
            font-size: 1.25rem;
        }

        .comparison-table .metric-row td {
            font-size: 0.95rem;
        }

        .comparison-table .section-header td {
            background: var(--lsca-green-light);
            font-weight: 600;
            color: var(--lsca-green-dark);
            text-align: left;
            padding: 0.75rem 1rem;
        }
        .office-filters {
            max-height: 200px;
            overflow-y: auto;
        }

        .clear-filters {
            background: none;
            border: none;
            color: var(--lsca-green);
            font-size: 0.8rem;
            cursor: pointer;
            padding: 0.25rem 0;
            margin-top: 0.5rem;
        }

        .clear-filters:hover {
             text-decoration: underline;
}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <img src="https://images.squarespace-cdn.com/content/v1/646e3b899493ae261720e957/c97bb057-7d9d-4a29-b019-9dd824be333c/logo.png" alt="Law Students for Climate Accountability" class="logo">
            <nav class="nav-links">
                <a href="https://ls4ca.org/scorecard">Scorecard</a>
                <a href="/" class="active">Profiles</a>
                <a href="https://ls4ca.org/take-action">Take Action</a>
                <a href="https://ls4ca.org/about">About</a>
            </nav>
        </div>
    </header>

    <!-- Page Title -->
    <section class="page-title">
        <h1><em>The</em> FIRM CLIMATE PROFILES</h1>
        <p>Explore how the Vault 100 law firms are shaping the climate crisis. Find firms aligned with your values.</p>
    </section>

    <!-- Search Section -->
    <section class="search-section">
        <div class="search-bar">
            <input type="text" class="search-input" id="firmSearch" placeholder="Search firms by name...">
        </div>
    </section>

    <!-- Main Layout -->
    <main class="main-layout">
        <!-- Filter Sidebar -->
        <aside class="filter-sidebar">
            <h3 class="filter-title">Filter Firms</h3>
            
            <div class="filter-group">
                <div class="filter-group-title">Climate Grade</div>
                <label class="filter-option">
                    <input type="checkbox" class="grade-filter" value="A" checked>
                    <span class="grade-indicator" style="background: var(--grade-a);">A</span>
                    A-Grade
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="grade-filter" value="B" checked>
                    <span class="grade-indicator" style="background: var(--grade-b);">B</span>
                    B-Grade
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="grade-filter" value="C" checked>
                    <span class="grade-indicator" style="background: var(--grade-c);">C</span>
                    C-Grade
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="grade-filter" value="D" checked>
                    <span class="grade-indicator" style="background: var(--grade-d);">D</span>
                    D-Grade
                </label>
                <label class="filter-option">
                    <input type="checkbox" class="grade-filter" value="F" checked>
                    <span class="grade-indicator" style="background: var(--grade-f);">F</span>
                    F-Grade
                </label>
            </div>

            <div class="filter-group">
                <div class="filter-group-title">OCI Office Location</div>
                <div class="office-filters" id="officeFilters"></div>
                <button class="clear-filters" id="clearOfficeFilters" style="display: none;">Clear office filters</button>
            </div>

            <div class="filter-group">
                <div class="filter-group-title">Practice Areas</div>
                <div class="filter-placeholder">Coming soon</div>
            </div>

            <div class="filter-group">
                <div class="filter-group-title">Engagement Status</div>
                <div class="filter-placeholder">Coming soon</div>
            </div>
        </aside>

        <!-- Firms Grid by Grade -->
        <div class="firms-container" id="firmsContainer">
            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading firm data...</p>
            </div>

            <!-- A-Grade Bucket -->
            <section class="grade-bucket hidden" data-grade="A">
                <div class="bucket-header">
                    <div class="bucket-grade" style="background: var(--grade-a);">A</div>
                    <div class="bucket-info">
                        <h2>A-Grade Firms</h2>
                        <p>Climate leaders with minimal fossil fuel involvement</p>
                    </div>
                    <span class="bucket-count"><span class="count">0</span> firms</span>
                </div>
                <div class="firms-grid" id="grade-a-grid"></div>
            </section>

            <!-- B-Grade Bucket -->
            <section class="grade-bucket hidden" data-grade="B">
                <div class="bucket-header">
                    <div class="bucket-grade" style="background: var(--grade-b);">B</div>
                    <div class="bucket-info">
                        <h2>B-Grade Firms</h2>
                        <p>Above average climate performance</p>
                    </div>
                    <span class="bucket-count"><span class="count">0</span> firms</span>
                </div>
                <div class="firms-grid" id="grade-b-grid"></div>
            </section>

            <!-- C-Grade Bucket -->
            <section class="grade-bucket hidden" data-grade="C">
                <div class="bucket-header">
                    <div class="bucket-grade" style="background: var(--grade-c);">C</div>
                    <div class="bucket-info">
                        <h2>C-Grade Firms</h2>
                        <p>Mixed climate record</p>
                    </div>
                    <span class="bucket-count"><span class="count">0</span> firms</span>
                </div>
                <div class="firms-grid" id="grade-c-grid"></div>
            </section>

            <!-- D-Grade Bucket -->
            <section class="grade-bucket hidden" data-grade="D">
                <div class="bucket-header">
                    <div class="bucket-grade" style="background: var(--grade-d);">D</div>
                    <div class="bucket-info">
                        <h2>D-Grade Firms</h2>
                        <p>Below average climate performance</p>
                    </div>
                    <span class="bucket-count"><span class="count">0</span> firms</span>
                </div>
                <div class="firms-grid" id="grade-d-grid"></div>
            </section>

            <!-- F-Grade Bucket -->
            <section class="grade-bucket hidden" data-grade="F">
                <div class="bucket-header">
                    <div class="bucket-grade" style="background: var(--grade-f);">F</div>
                    <div class="bucket-info">
                        <h2>F-Grade Firms</h2>
                        <p>Significant fossil fuel involvement</p>
                    </div>
                    <span class="bucket-count"><span class="count">0</span> firms</span>
                </div>
                <div class="firms-grid" id="grade-f-grid"></div>
            </section>

            <!-- No Results Message -->
            <div class="no-results" id="noResults" style="display: none;">
                <h3>No firms found</h3>
                <p>Try adjusting your search or filters.</p>
            </div>
        </div>
    </main>

    <!-- Compare Bar -->
    <div class="compare-bar" id="compareBar">
        <div class="compare-bar-content">
            <span class="compare-count"><span id="compareCount">0</span>/4 firms selected</span>
            <div class="selected-firms" id="selectedFirms"></div>
        </div>
        <div class="compare-bar-actions">
            <button class="clear-btn" id="clearCompare">Clear All</button>
            <button class="compare-btn" id="openCompare">Compare Firms</button>
        </div>
    </div>

    <!-- Comparison Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <h2>Firm Comparison</h2>
                <button class="modal-close" id="modalClose">√ó</button>
            </div>
            <div class="modal-body">
                <table class="comparison-table" id="comparisonTable"></table>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="site-footer">
        <img src="https://images.squarespace-cdn.com/content/v1/646e3b899493ae261720e957/90bf33a1-f881-4bde-b7eb-3cb81575ece0/white+logo.png" alt="LSCA" class="footer-logo">
        <p class="footer-text">Law Students for Climate Accountability is a fiscally sponsored project of Earth Island Institute, a 501(c)(3) nonprofit organization.</p>
    </footer>

    <script>
        // Google Sheets CSV URL
        const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSWOJ6eD5ufutrYKS7oiy09dqDdRJCKoxkOioTK7OSWWBWmMdpMlGjnjbuzrkNatA/pub?gid=1883963685&single=true&output=csv';

        // Global firms array
        let firms = [];
        const majorOffices = ['New York', 'Washington DC', 'Los Angeles', 'Chicago', 'San Francisco', 'Boston', 'Houston', 'Dallas', 'Atlanta', 'Miami', 'Silicon Valley', 'Palo Alto'];

        // Grade color mapping
        const gradeColors = {
            'A': 'var(--grade-a)',
            'B': 'var(--grade-b)',
            'C': 'var(--grade-c)',
            'D': 'var(--grade-d)',
            'F': 'var(--grade-f)'
        };

        // Parse CSV row into firm object
        function parseRow(row) {
            // Skip rows without a firm name or slug
            if (!row['Firm Name'] || !row['Firm Slug']) return null;
            
            // Skip the field type description row (row 2)
            if (row['Vault Rank'] === 'Number (auto-filled)') return null;

            return {
                rank: parseInt(row['Vault Rank']) || 0,
                name: row['Firm Name'] || '',
                slug: row['Firm Slug'] || '',
                logo: row['Firm Logo'] || null,
                grade: row['Overall Grade'] || '',
                transaction: row['Transaction Grade'] || '',
                litigation: row['Litigation Grade'] || '',
                lobbying: row['Lobbying Grade'] || '',
                priorGrade: row['Prior Year Grade (2024)'] || '',
                transactionRank: parseInt(row['Transaction Rank']) || 0,
                litigationRank: parseInt(row['Litigation Rank']) || 0,
                engagementStatus: row['Engagement Status'] || 'No Response',
                ociOffices: row['OCI Offices'] || ''
            };
        
        }

        // Fetch and parse Google Sheets data
        async function loadFirmData() {
            try {
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        firms = results.data
                            .map(parseRow)
                            .filter(firm => firm !== null && firm.name && firm.grade);
                        
                       // Hide loading, show content
                        document.getElementById('loadingState').style.display = 'none';
                        populateOfficeFilters();
                        populateGrids();
                        initComparison();
                    },
                    error: function(error) {
                        console.error('CSV parse error:', error);
                        showError();
                    }
                });
            } catch (error) {
                console.error('Fetch error:', error);
                showError();
            }
        }

        function showError() {
            document.getElementById('loadingState').innerHTML = `
                <p style="color: var(--grade-f);">Error loading firm data. Please refresh the page.</p>
            `;
        }

        function populateOfficeFilters() {
    const container = document.getElementById('officeFilters');
    container.innerHTML = majorOffices.map(office => `
        <label class="filter-option">
            <input type="checkbox" class="office-filter" value="${office}">
            ${office}
        </label>
    `).join('');
    
    document.querySelectorAll('.office-filter').forEach(cb => {
        cb.addEventListener('change', () => {
            filterFirms();
            updateClearButton();
        });
    });
}

function updateClearButton() {
    const anyChecked = document.querySelectorAll('.office-filter:checked').length > 0;
    document.getElementById('clearOfficeFilters').style.display = anyChecked ? 'block' : 'none';
}

        // Create a firm card
        function createFirmCard(firm) {
            const logoHtml = firm.logo 
                ? `<img src="${firm.logo}" alt="${firm.name} logo" class="firm-logo" onerror="this.parentElement.innerHTML='<span>Logo</span>'">`
                : `<span>Logo</span>`;
            
            const gradeColor = gradeColors[firm.grade] || 'var(--text-muted)';
            const transactionColor = gradeColors[firm.transaction] || 'var(--text-muted)';
            const litigationColor = gradeColors[firm.litigation] || 'var(--text-muted)';
            const lobbyingColor = gradeColors[firm.lobbying] || 'var(--text-muted)';

            return `
                <div class="firm-card" data-grade="${firm.grade}" data-name="${firm.name.toLowerCase()}" data-slug="${firm.slug}" data-firm="${firm.name}" data-offices="${firm.ociOffices.toLowerCase()}">
                    <div class="card-top">
                        <span class="vault-rank">#${firm.rank}</span>
                        <label class="compare-checkbox" title="Add to compare">
                            <input type="checkbox" class="compare-check" data-firm="${firm.name}">
                        </label>
                    </div>
                    <div class="logo-placeholder ${firm.logo ? 'has-logo' : ''}">
                        ${logoHtml}
                    </div>
                    <div class="firm-name">${firm.name}</div>
                    <div class="card-grades">
                        <div class="overall-grade" style="background: ${gradeColor};">${firm.grade || '?'}</div>
                        <div class="sub-grades">
                            <div class="sub-grade" title="Transactions">
                                <span class="sub-grade-icon">ü§ù</span>
                                <div class="sub-grade-value" style="background: ${transactionColor};">${firm.transaction || '?'}</div>
                            </div>
                            <div class="sub-grade" title="Litigation">
                                <span class="sub-grade-icon">‚öñÔ∏è</span>
                                <div class="sub-grade-value" style="background: ${litigationColor};">${firm.litigation || '?'}</div>
                            </div>
                            <div class="sub-grade" title="Lobbying">
                                <span class="sub-grade-icon">üèõÔ∏è</span>
                                <div class="sub-grade-value" style="background: ${lobbyingColor};">${firm.lobbying || '?'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Populate grids
        function populateGrids() {
            const grades = ['A', 'B', 'C', 'D', 'F'];
            grades.forEach(grade => {
                const bucket = document.querySelector(`.grade-bucket[data-grade="${grade}"]`);
                const grid = document.getElementById(`grade-${grade.toLowerCase()}-grid`);
                const gradeFirms = firms.filter(f => f.grade === grade).sort((a, b) => a.rank - b.rank);
                
                if (gradeFirms.length > 0) {
                    grid.innerHTML = gradeFirms.map(createFirmCard).join('');
                    bucket.querySelector('.count').textContent = gradeFirms.length;
                    bucket.classList.remove('hidden');
                }
            });
        }

        // Filter and search functionality
        function filterFirms() {
    const searchTerm = document.getElementById('firmSearch').value.toLowerCase();
    const checkedGrades = Array.from(document.querySelectorAll('.grade-filter:checked')).map(cb => cb.value);
    const checkedOffices = Array.from(document.querySelectorAll('.office-filter:checked')).map(cb => cb.value.toLowerCase());
    
    let totalVisible = 0;
    const grades = ['A', 'B', 'C', 'D', 'F'];
    
    grades.forEach(grade => {
        const bucket = document.querySelector(`.grade-bucket[data-grade="${grade}"]`);
        const cards = bucket.querySelectorAll('.firm-card');
        let visibleInBucket = 0;
        
        cards.forEach(card => {
            const cardGrade = card.dataset.grade;
            const cardName = card.dataset.name;
            const cardOffices = card.dataset.offices;
            
            const matchesSearch = cardName.includes(searchTerm);
            const matchesGrade = checkedGrades.includes(cardGrade);
            
            let matchesOffice = true;
            if (checkedOffices.length > 0) {
                matchesOffice = checkedOffices.some(office => cardOffices.includes(office));
            }
            
            if (matchesSearch && matchesGrade && matchesOffice) {
                card.classList.remove('hidden');
                visibleInBucket++;
                totalVisible++;
            } else {
                card.classList.add('hidden');
            }
        });
        
        const countEl = bucket.querySelector('.count');
        countEl.textContent = visibleInBucket;
        
        if (visibleInBucket === 0 || !checkedGrades.includes(grade)) {
            bucket.classList.add('hidden');
        } else {
            bucket.classList.remove('hidden');
        }
    });
    
    document.getElementById('noResults').style.display = totalVisible === 0 ? 'block' : 'none';
}

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFirmData();
            
            // Search listener
            document.getElementById('firmSearch').addEventListener('input', filterFirms);
            
            // Grade filter listeners
            document.querySelectorAll('.grade-filter').forEach(cb => {
                cb.addEventListener('change', filterFirms);
            });
            
            // Card click to go to profile
            document.addEventListener('click', (e) => {
                const card = e.target.closest('.firm-card');
                if (card && !e.target.closest('.compare-checkbox')) {
                    const slug = card.dataset.slug;
                    if (slug) {
                        window.location.href = '/lsca-profiles/' + slug;
                    }
                }
            });
            // Clear office filters
            document.getElementById('clearOfficeFilters').addEventListener('click', () => {
                document.querySelectorAll('.office-filter').forEach(cb => cb.checked = false);
                filterFirms();
                updateClearButton();
            });
        });

        // Comparison state
        let selectedFirms = [];
        const MAX_COMPARE = 4;

        function initComparison() {
            const compareBar = document.getElementById('compareBar');
            const compareCount = document.getElementById('compareCount');
            const selectedFirmsContainer = document.getElementById('selectedFirms');
            const clearBtn = document.getElementById('clearCompare');
            const openBtn = document.getElementById('openCompare');
            const modalOverlay = document.getElementById('modalOverlay');
            const modalClose = document.getElementById('modalClose');

            // Checkbox change handler
            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('compare-check')) {
                    const firmName = e.target.dataset.firm;
                    
                    if (e.target.checked) {
                        if (selectedFirms.length < MAX_COMPARE) {
                            selectedFirms.push(firmName);
                        } else {
                            e.target.checked = false;
                            alert(`Maximum ${MAX_COMPARE} firms can be compared at once.`);
                        }
                    } else {
                        selectedFirms = selectedFirms.filter(f => f !== firmName);
                    }
                    
                    updateCompareBar();
                }
            });

            // Clear all
            clearBtn.addEventListener('click', () => {
                selectedFirms = [];
                document.querySelectorAll('.compare-check').forEach(cb => cb.checked = false);
                updateCompareBar();
            });

            // Open modal
            openBtn.addEventListener('click', () => {
                if (selectedFirms.length >= 2) {
                    buildComparisonTable();
                    modalOverlay.classList.add('visible');
                }
            });

            // Close modal
            modalClose.addEventListener('click', () => {
                modalOverlay.classList.remove('visible');
            });

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    modalOverlay.classList.remove('visible');
                }
            });

            // Remove individual firm from selection
            selectedFirmsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove')) {
                    const firmName = e.target.dataset.firm;
                    selectedFirms = selectedFirms.filter(f => f !== firmName);
                    
                    // Uncheck the checkbox
                    const checkbox = document.querySelector(`.compare-check[data-firm="${firmName}"]`);
                    if (checkbox) checkbox.checked = false;
                    
                    updateCompareBar();
                }
            });
        }

        function updateCompareBar() {
            const compareBar = document.getElementById('compareBar');
            const compareCount = document.getElementById('compareCount');
            const selectedFirmsContainer = document.getElementById('selectedFirms');
            const openBtn = document.getElementById('openCompare');

            compareCount.textContent = selectedFirms.length;

            // Show/hide bar
            if (selectedFirms.length >= 2) {
                compareBar.classList.add('visible');
            } else {
                compareBar.classList.remove('visible');
            }

            // Update selected firms tags
            selectedFirmsContainer.innerHTML = selectedFirms.map(name => {
                const shortName = name.length > 20 ? name.substring(0, 20) + '...' : name;
                return `<span class="selected-firm-tag">${shortName}<span class="remove" data-firm="${name}">√ó</span></span>`;
            }).join('');

            // Enable/disable compare button
            openBtn.disabled = selectedFirms.length < 2;
        }

        function buildComparisonTable() {
            const table = document.getElementById('comparisonTable');
            const selectedFirmData = selectedFirms.map(name => firms.find(f => f.name === name));

            const rows = [
                { section: 'Overview' },
                { label: 'Vault Rank', key: 'rank', format: (v) => `#${v}` },
                { label: 'Climate Grade', key: 'grade', isGrade: true },
                { section: 'Sub-Grades' },
                { label: 'ü§ù Transactions', key: 'transaction', isGrade: true },
                { label: '‚öñÔ∏è Litigation', key: 'litigation', isGrade: true },
                { label: 'üèõÔ∏è Lobbying', key: 'lobbying', isGrade: true }
            ];

            let html = `
                <thead>
                    <tr>
                        <th></th>
                        ${selectedFirmData.map(firm => `
                            <th class="firm-header">
                                <div class="firm-header-content">
                                    ${firm.logo 
                                        ? `<img src="${firm.logo}" alt="${firm.name}" class="firm-header-logo">`
                                        : `<div style="height: 40px; display: flex; align-items: center; color: var(--text-muted);">No logo</div>`
                                    }
                                    <span class="firm-header-name">${firm.name}</span>
                                    <span class="firm-header-rank">#${firm.rank}</span>
                                </div>
                            </th>
                        `).join('')}
                    </tr>
                </thead>
                <tbody>
            `;

            rows.forEach(row => {
                if (row.section) {
                    html += `
                        <tr class="section-header">
                            <td colspan="${selectedFirmData.length + 1}">${row.section}</td>
                        </tr>
                    `;
                } else {
                    html += `
                        <tr class="metric-row">
                            <td>${row.label}</td>
                            ${selectedFirmData.map(firm => {
                                const value = firm[row.key];
                                if (row.isGrade) {
                                    return `<td class="grade-cell" style="color: ${gradeColors[value] || 'inherit'}">${value || '?'}</td>`;
                                } else if (row.format) {
                                    return `<td>${row.format(value)}</td>`;
                                } else {
                                    return `<td>${value}</td>`;
                                }
                            }).join('')}
                        </tr>
                    `;
                }
            });

            html += '</tbody>';
            table.innerHTML = html;
        }
    </script>
</body>
</html>
